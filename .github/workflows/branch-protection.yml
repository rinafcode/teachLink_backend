# Branch Protection Configuration
#
# GitHub does not support configuring branch protection rules via YAML files
# checked into the repository. Rules must be applied through one of:
#
#   A) The GitHub web UI (Settings â†’ Branches)        â€” manual, per-repo
#   B) The GitHub REST API / GraphQL API              â€” scriptable
#   C) github-script in a one-time bootstrap workflow â€” automated
#
# This file serves as the AUTHORITATIVE SPECIFICATION for all branch protection
# settings. It is used by the bootstrap workflow below AND as documentation
# for maintainers who need to restore settings after a repository migration.
#
# To apply these rules to a new repository or restore them after accidental
# deletion, run the "Bootstrap Branch Protection" workflow manually from the
# Actions tab (workflow_dispatch trigger).
#
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# REQUIRED SECRETS (set in repo Settings â†’ Secrets â†’ Actions):
#
#   BRANCH_PROTECTION_TOKEN
#     A GitHub Personal Access Token (classic) with scope: repo
#     OR a fine-grained PAT with "Administration" read+write permission.
#     The default GITHUB_TOKEN does NOT have permission to write branch
#     protection rules â€” a dedicated PAT is required.
#
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: Bootstrap Branch Protection

on:
  # Run manually from the GitHub Actions UI whenever rules need to be applied
  # or restored. Never runs automatically to avoid unintended overrides.
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run â€” print settings without applying them'
        type: boolean
        default: true
        required: true

jobs:
  apply-branch-protection:
    name: Apply Branch Protection Rules
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # â”€â”€ Apply rules for `main` â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Configure protection for `main`
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BRANCH_PROTECTION_TOKEN }}
          script: |
            const isDryRun = ${{ inputs.dry_run }};
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const branch = 'main';

            // â”€â”€ Settings spec for `main` â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            //
            // required_status_checks
            //   Set to the SINGLE aggregate job "CI Passed" defined in ci.yml.
            //   This avoids updating this list every time individual job names
            //   change inside the workflow file.
            //
            // required_pull_request_reviews
            //   required_approving_review_count: 2
            //     Two maintainer approvals are required before merging to main.
            //   dismiss_stale_reviews: true
            //     Any new commit to the PR invalidates existing approvals.
            //     Reviewers must re-approve after seeing the new changes.
            //   require_code_owner_reviews: true
            //     At least one of the required approvals must come from a
            //     CODEOWNERS entry matching the changed files.
            //
            // enforce_admins: true
            //   Admins are NOT exempt. All rules apply equally.
            //
            // restrictions: null
            //   No push restrictions beyond the PR requirement (direct push
            //   is blocked by require_pull_request_reviews alone).
            //
            // allow_force_pushes: false
            // allow_deletions: false
            //   The main branch history is permanent and rewrite-protected.
            //
            // required_conversation_resolution: true
            //   All PR review threads must be marked resolved before merge.
            //
            // required_linear_history: true
            //   Only squash-merge is permitted; no merge commits on main.

            const mainSettings = {
              owner,
              repo,
              branch,
              required_status_checks: {
                strict: true,            // branch must be up to date before merge
                contexts: ['CI Passed'], // single aggregate job from ci.yml
              },
              enforce_admins: true,
              required_pull_request_reviews: {
                dismiss_stale_reviews: true,
                require_code_owner_reviews: true,
                required_approving_review_count: 2,
                require_last_push_approval: true,
              },
              restrictions: null,
              allow_force_pushes: false,
              allow_deletions: false,
              required_conversation_resolution: true,
              required_linear_history: true,
              block_creations: false,
            };

            console.log(`\n=== Branch protection for '${branch}' ===`);
            console.log(JSON.stringify(mainSettings, null, 2));

            if (!isDryRun) {
              await github.rest.repos.updateBranchProtection(mainSettings);
              console.log(`âœ… Applied protection rules to '${branch}'`);
            } else {
              console.log('â„¹ï¸  DRY RUN â€” no changes applied.');
            }

      # â”€â”€ Apply rules for `develop` â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Configure protection for `develop`
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BRANCH_PROTECTION_TOKEN }}
          script: |
            const isDryRun = ${{ inputs.dry_run }};
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const branch = 'develop';

            // â”€â”€ Settings spec for `develop` â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            //
            // required_approving_review_count: 1
            //   One team member approval is sufficient for the integration
            //   branch. The stricter 2-approval rule applies only to main.
            //
            // require_code_owner_reviews: true
            //   Still required on develop to ensure module owners review
            //   changes to their areas before they reach main.
            //
            // All other settings mirror main.

            const developSettings = {
              owner,
              repo,
              branch,
              required_status_checks: {
                strict: true,
                contexts: ['CI Passed'],
              },
              enforce_admins: true,
              required_pull_request_reviews: {
                dismiss_stale_reviews: true,
                require_code_owner_reviews: true,
                required_approving_review_count: 1,
                require_last_push_approval: true,
              },
              restrictions: null,
              allow_force_pushes: false,
              allow_deletions: false,
              required_conversation_resolution: true,
              required_linear_history: true,
              block_creations: false,
            };

            console.log(`\n=== Branch protection for '${branch}' ===`);
            console.log(JSON.stringify(developSettings, null, 2));

            if (!isDryRun) {
              await github.rest.repos.updateBranchProtection(developSettings);
              console.log(`âœ… Applied protection rules to '${branch}'`);
            } else {
              console.log('â„¹ï¸  DRY RUN â€” no changes applied.');
            }

      - name: Summary
        run: |
          echo "## Branch Protection Bootstrap" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "**Mode:** ðŸ” Dry run â€” settings printed but NOT applied" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Re-run with \`dry_run: false\` to apply the rules." >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** âœ… Applied â€” branch protection rules are now active" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Branch | Required approvals | Stale review dismissal | Code owner review | Status checks | Up to date | Conversation resolution |" >> $GITHUB_STEP_SUMMARY
            echo "|---|---|---|---|---|---|---|" >> $GITHUB_STEP_SUMMARY
            echo "| \`main\` | 2 | âœ… | âœ… | CI Passed | âœ… | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| \`develop\` | 1 | âœ… | âœ… | CI Passed | âœ… | âœ… |" >> $GITHUB_STEP_SUMMARY
          fi
